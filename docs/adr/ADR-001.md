# ADR-001 — Defer Official Go/.NET/JNI/Swift Bindings to Post-MVP, Keep C ABI Stable and Provide DIY Cookbook

**Date:** 2025-10-23
**Status:** Accepted
**Deciders:** EqualFi Labs Core (ZKD)
**Review Date:** 2026-01-31
**Related:** ROADMAP.md, INTERFACES.md, TEST-PLAN.md, TASKLIST.md, ARCHITECTURE.md, golden-vectors.md, threat-model.md

---

## 1) Context

ZKD exposes a stable C ABI over a Rust core and ships multiple integration surfaces suitable for Phase-0/Phase-1 adoption:

* **Already shipping:**

  * **C ABI** (canonical FFI surface)
  * **Python** (cross-platform)
  * **Flutter/Dart** (mobile: Android + iOS)
  * **WASI** (browser/runtime targets)
  * CLI/SDK workflows mirroring the ABI

Four additional language families were scoped as “nice-to-have” for broader ecosystem reach:

* **Go (cgo)**
* **.NET (C# P/Invoke)**
* **Java/Kotlin (JNI) + Android AAR**
* **Swift/iOS (SwiftPM systemLibrary)**

Carrying these bindings in-house increases CI matrix size, packaging/release complexity, and maintenance burden without improving the core determinism guarantees (asserted at the proof layer via golden vectors and backend parity). Current priorities emphasize prover stability, deterministic outputs across backends, and clean developer ergonomics on the existing surfaces.

---

## 2) Decision

**Defer** the following **official** bindings to a later “Ecosystem” phase:

* Go (cgo), .NET (P/Invoke), Java/Kotlin (JNI + AAR), Swift/iOS (SPM)

**Maintain** the following **as the supported Phase-0/1 integration surfaces:**

* C ABI (stable contract)
* Python
* Flutter/Dart (Android/iOS)
* WASI (browser/runtime)

**Mitigations for developers needing deferred targets now:**

* Publish a **DIY Bindings Cookbook** describing thin wrappers over the C ABI for each deferred language, including build flags, symbol mapping, memory management patterns, and error handling (JSON-encoded errors).

This decision updates ROADMAP.md and INTERFACES.md to make language coverage **non-normative** for determinism and clearly communicates availability.

---

## 3) Rationale / Drivers

* **Determinism focus:** Proof-layer equivalence is binding-agnostic; more language SKUs do not strengthen guarantees.
* **Risk & surface area reduction:** Fewer native package toolchains and installers in Phase-0 lowers supply-chain and CI flake risk.
* **Time-to-stability:** Concentrating effort on the C ABI, Python, Flutter, and WASI accelerates polish and documentation quality.
* **DX sufficiency:** The existing set spans server, mobile, and browser; most teams can integrate today via these paths or minimal C FFI.

---

## 4) Options Considered

1. **Ship all bindings now (original scope).**

   * Pros: maximal reach.
   * Cons: heavy CI/release burden; increased maintenance; limited value to determinism; slower polish.

2. **Defer all four (chosen).**

   * Pros: focus, lower risk, faster polish on shipping targets.
   * Cons: developers in Go/.NET/JNI/Swift need DIY steps short-term.

3. **“Minimal wrappers” now, bless community to own them.**

   * Pros: coverage without full ownership.
   * Cons: fragmentation risk; support ambiguity; quality varies.

4. **Autogenerate via SWIG/cbindgen/JNAerator, etc.**

   * Pros: bootstraps quickly.
   * Cons: leaky abstractions, fragile build toolchains, poor ergonomics.

---

## 5) Consequences

### Positive

* Reduced CI matrix (fewer runners, fewer toolchains).
* Smaller attack surface per threat model; fewer packaging supply chains.
* Faster stabilization of docs, examples, and golden-vector pipelines.
* Clearer promise surface for Phase-0/1 users.

### Negative

* Some teams (Go/.NET/JNI/Swift) will implement thin wrappers themselves.
* Slightly higher initial friction for those ecosystems until official packages land.

### Neutral/Managed

* Determinism guarantees remain unchanged (asserted via golden vectors across backends, not per language binding).

---

## 6) Technical Notes / Non-Functional Requirements

* **C ABI is the contract.**

  * Symbol stability: `zkp_init`, `zkp_prove`, `zkp_verify`, `zkp_list_*`, `zkp_free_*` (or equivalent stable set).
  * **Error model:** JSON-encoded errors and result payloads.
  * **Memory ownership:** All heap buffers returned across the FFI boundary include explicit `*_free` APIs; no implicit ownership transfer.
  * **Threading:** Reentrant verify; prove may use internal threading but must remain deterministic for identical inputs.
  * **Versioning:** Semantic version visible to callers via `zkp_version()` and embedded in JSON results.

* **DIY Bindings Cookbook (minimum content):**

  * **Go:** `#cgo LDFLAGS`, header include, `unsafe.Pointer` for buffers, finalizers, and `errno`/return code mapping.
  * **.NET:** `[DllImport]` signatures, `SafeHandle`/`CriticalHandle` patterns, UTF-8 marshaling, platform-specific library names.
  * **Java/Kotlin:** Prefer **JNA** for v0 (fewer moving parts) with a JNI appendix for performance-critical paths; AAR packaging guidance for Android.
  * **Swift/iOS:** SwiftPM `systemLibrary` target; bridging header; `withUnsafeBytes` and `ManagedBufferPointer` patterns.

---

## 7) Security & Compliance

* Fewer build/distribution channels reduce **supply-chain** exposure.
* Centralizing validation at the C ABI and preserving the proof-layer golden vectors keeps **integrity** guarantees intact.
* No additional privacy or key-handling surfaces are introduced by deferral.

---

## 8) Impact on Testing & CI

* **No change** to golden-vector policy; parity is asserted per backend (native/WASI) and via CLI/SDK paths.
* CI matrix simplifies (drop Go/.NET/JNI/Swift packaging and integration tests).
* Add tests ensuring **ABI symbol presence**, **version reporting**, and **round-trip memory** correctness remain stable.

---

## 9) Documentation & Roadmap Updates (Scope Lock)

* **ROADMAP.md:** Under Phase-0/1, list **C ABI, Python, Flutter/Dart, WASI** as the shipped bindings. Move Go/.NET/JNI/Swift to the **Ecosystem** phase.
* **INTERFACES.md:** Mark **language coverage as non-normative** for determinism; add an **Availability** line and link to the DIY cookbook.
* **TEST-PLAN.md:** Confirm that language binding parity is **out of scope**; tests anchor at proof outputs and ABI conformance.
* **TASKLIST.md:** Move corresponding tasks to deferred status; add a task to publish the cookbook.
* **README/Docs:** Update “Getting Started / Bindings” to reflect current availability and point to the cookbook.

---

## 10) Success Metrics

* ≥95% pass rate on golden-vector suites across supported backends and platforms.
* Zero ABI-breaking changes before the scheduled review date.
* Documentation completeness: cookbook covers all four deferred ecosystems.
* Reduction in CI minutes and flaky job rate compared to pre-deferral baseline.

---

## 11) Risks & Mitigations

* **Ecosystem frustration:** Developers in deferred languages may hesitate to adopt.

  * *Mitigation:* Ship high-quality cookbook, exemplars, and a minimal C header; invite contributions with a clear acceptance path.
* **Fragmentation:** Community packages diverge.

  * *Mitigation:* Keep ABI crisp and versioned; publish conformance checklist and sample tests.
* **Future integration drag:** Re-introducing official bindings later may require packaging rework.

  * *Mitigation:* Record packaging decisions now (library names, symbol visibility, version query), easing future official releases.

---

## 12) Implementation Plan

* [ ] Update ROADMAP.md to reflect binding availability and deferral.
* [ ] Update INTERFACES.md with “Availability” and non-normative language coverage note.
* [ ] Update TEST-PLAN.md to reaffirm proof-layer parity as the gate.
* [ ] Update TASKLIST.md: mark Tasks 0.9.4–0.9.7 as “Deferred”; add cookbook task.
* [ ] Add `/docs/bindings-cookbook.md` with four sections (Go/.NET/Java/Kotlin/Swift).
* [ ] Trim CI: remove packaging/build jobs for deferred bindings (if any scaffolds exist).
* [ ] Add ABI stability tests (symbol presence, version, error JSON shape, buffer ownership).
* [ ] Announce scope change in CHANGELOG/Release Notes.

---

## 13) Reconsideration Criteria (for future un-deferral)

Revisit when at least two of the following hold:

* Persistent community demand from production users in a deferred language.
* Maintainer bandwidth to own release pipelines.
* Stabilized core + low CI flake rate for ≥2 releases.
* Funding/grants earmarked for language-specific distribution engineering.

---

## 14) Decision Summary (Executive)

To accelerate stability and reduce risk, ship Phase-0/1 with C ABI, Python, Flutter/Dart, and WASI. Defer official Go/.NET/JNI/Swift bindings, replacing them with a documented DIY path. Determinism guarantees remain unaffected; developer experience stays strong across mobile, server, and browser—with a clear, low-friction escape hatch for deferred ecosystems.
